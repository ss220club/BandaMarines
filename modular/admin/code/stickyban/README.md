# Модулярный Stickyban (Banda)

## Область действия
- Поведение в этой папке реализуется только модулем.
- Файлы хардкода вне `modular/admin/code/stickyban*` не изменяются.
- Интеграция выполняется через существующие `hascall/call`-хуки.

## Инварианты модели данных
- Канонический идентификатор stickyban: нормализованный `identifier = ckey(trim(identifier))`.
- Пустые legacy-идентификаторы приводятся к синтетическому значению: `legacy_empty_<root_id>`.
- Ожидаются уникальные ограничения:
  - `stickyban(identifier)`
  - `stickyban_matched_ckey(linked_stickyban, ckey)`
  - `stickyban_matched_cid(linked_stickyban, cid)`
  - `stickyban_matched_ip(linked_stickyban, ip)`

## Графовая нормализация
- Сильные связи:
  - одинаковый нормализованный `identifier`
  - общий не-whitelisted `CKEY`
  - общий `CID`
- Ограниченная IP-связь:
  - IP учитывается только для root, которые уже участвуют в сильных сигналах.
- Обработка кластера:
  - выбор canonical root: сначала active, затем максимальный id
  - перенос match-строк в canonical root
  - поля `reason/message/date/adminid` берутся из самого нового root (max id)
  - удаление дублей root

## Правила рантайма
- Legacy import отключен модульным no-op перехватчиком.
- Legacy-логика `on_insert` обходится модульным хуком.
- Политика anti-bloat при логине:
  - не создается авто-связь по CKEY;
  - IP/CID добавляются только если ckey не whitelisted в кластере.

## Стартовый поток
1. Очистка сиротских и дублирующихся match-строк.
2. Графовая нормализация root-дублей.
3. Best-effort ресинк уникальных индексов stickyban.

## Админ-операции
- Аудит показывает:
  - кандидатов на cleanup в match-таблицах
  - группы дублей по identifier
  - граф-кластеры дублей
- Нормализация выполняет графовое слияние и возвращает расширенный summary.
- Удаление кластера удаляет весь граф-кластер выбранного root.
